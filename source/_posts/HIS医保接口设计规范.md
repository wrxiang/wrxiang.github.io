---
title: HIS医保接口设计规范
categories : 程序员日常思考
tag : [HIS, 医保]
date: 2019-09-09 22:30:03
---
## 背景
医保接口的开发可以说是HIS系统中极其重要的一部分，从某种意义上讲，医保接口实施的好坏直接影响项目总体的进度和效果，但是由于医保政策的复杂性，再加上医保往往有很大的地区差异，在项目交付的过程中，软件设计及开发人员经产会遇到许多比较复杂或者难以解决的问题。
结合之前项目中医保实施的经验，并对医保接口设计过程中的方法进行归纳，给出一种比较完善的设计解决方法和规范，可以帮助研发或实施人员更好的实施医保，目前只是一个粗糙的框架，还需要医保实践不断的进行扩充，以至形成一种比较稳定完善的综合性解决方案。
<!--more-->
## 医疗政策软件
通过对北京安宁盈科、创智和宇、东软、首都信息、杭州新世纪、建达电子、万达信息等各个医保政策软件提供商提供的接口方案进行分析，总结出他们之间的异同性如下：
1. 一般都提供DOS和Windows两套方案，Windows下一般以WIN32 API的形式进行调用（dll提供了政策函数），这里我们以Windows为重点进行说明。
2. 政策函数一般分为两类：单个函数和多个函数两种设计类型。多个函数是指每种业务或者比较相似的业务为一个函数，这样组成登记、结算、退费等，如杭州新世纪；单个函数是指所有业务都用一个函数实现，参数一般使用结构字符串实现，如东软公司。
3. 结算时费用明细数据分为实时上传和非实时上传，实时上传要求结算时就将费用明细上传至医保中心，比如首都信息公司接口，非实时上传则是为了减少网络阻塞，结算时只上传大类费用或总费用，费用明细可隔天上传，比如上海万达公司。
4. 住院或门诊发生费用时，药品/项目的自负比例一般分为三种类别，第一种自负比例按照HIS中设置的计算，并且也不用审批；第二种HIS中需要根据医保中心下发的药品/项目字典维护对照表，按照对照表中的自负比例计算，并且需要审批；第三种HIS计算费用时不管自负比例，只需对照好编码，在上传费用时医保中心会返回每条费用的自负比例。
5. 结算前一般都需要刷卡，有些地区的医保允许只在挂号或登记时刷卡，结算时可以不刷卡，只要能将个人信息从HIS中取出即可。
6. 结算分为预结算及结算两部分，预结算阶段处理数据的上传或调用医保的结算计算函数获取医保支付信息，结算阶段执行结算处理，和医保政策软件进行结算交易。一般预结算和结算医保政策软件返回的医保支付信息是一致的，但是在医保实施的过程中确实也发现有少数的医保在某些情况下预结算和结算结果不同，一旦出现这种情况，是需要HIS进行相应的处理的。

## 医保病人就诊流程
医保病人就诊的一般流程是：登记 → 发生费用 → 结算，此外还有结算作废、退款补结算等操作
* 登记：登记一般需要验证身份，一些医保可能还需要输入一些病人的入院信息。
* 发生费用：有些医保需要对药品/项目进行审批，有些则要按照统一的目录取值，这就要求HIS在记费时药品/项目和医保之间有一个对照。
* 结算：验证身份 → 预结算计算费用信息并获取医保支付信息 → 确认结算发送确认交易请求。
* 结算作废：一般需要验证身份，然后调用医保的结算作废，将操作的医保结算作废掉。
* 退款补结算：这里不是指结算作废，而是只退一部分，某些医保支持部分退的功能，有些不支持，支持的可以直接根据医保政策软件做，不支持的医保可以采取全部退然后再收一部分的步骤来实现。

对医保病人的就诊流程分析，我们可以看到尽管医保政策软件的接口千差万别，但是HIS中关注的操作主要是以下几个：身份验证、登记、预结算、结算、结算作废

## 接口规范设计
通过对医保政策软件以及医保病人就诊结算的流程进行分析，我们希望能够利用各个医保政策软件的共性，屏蔽其差异，隔离HIS和医保政策软件之间的业务交互，这样对于HIS来说，调用方式和接口是相同的，有利于医保的批量实施以及迎合各地医保业务的多变性，减少HIS程序频繁的修改和后期运维工作，所以医保接口设计规范总的原则如下：
1. HIS端业务和医保政策软件隔离，HIS窗口业务中不要加入医保的处理过程，但是可以加入对象方法的调用。不同的医保封装为不同的对象，对外暴漏统一的方法，根据不同的医保调用不同医保对象中的方法，这样的话上线医保仅需增加医保对象即可。这里需要注意的是医保对象的切换不要使用if进行判断，因为随着上线项目越来越多，需要支持的医保也不断增加，大量的if不利于系统维护，通过设计模式可以解决类似的应用场景。
2. 将HIS中调用医保的位置，事件名称及具体业务明确化，规范化，尽量减少HIS中调用医保接口的地方，或者在一个函数事件中集中处理，利于维护。
3. 函数返回值单一化，只有成功或失败两种情况，其他的返回信息可以组装成JSON返回。
4. 务必保证两个事务的一致性，很多地区做医保时没有考虑到这个问题，导致做报表时数据不一致。一般可以先进行HIS业务，再做医保业务，这样有个好处HIS业务正常才会调用医保，而且万一医保失败我们可以回滚HIS业务。很多HIS系统和医保政策软件进行交易时往往先调用医保接口，医保成功才会进行HIS业务，这样做主要是要确保HIS成功则医保一定是成功的，采用这种方式万一医保成功，HIS失败则需要提供工具，可以让操作员或者实施人员能够撤销医保的这次交易，并且需要保证一次结算不能重复的调用医保结算交易，保证数据的正确性。无论是先调用医保还是后调用医保，都需要保证HIS和医保的事务一致性。

## 用户接口函数
医保政策软件对应的医保处理对象中必须包含以下对外调用的接口函数
### 门诊挂号
* ReadCardRegistOp：门诊挂号中，在挂号界面里的读卡键或卡号显示框触发回车时产生该请求，此操作用于病人的身份验证
* ReadyRegistOp：门诊挂号中，点击挂号结算按钮时产生该请求，主要是调用医保挂号计算方法获取医保支付信息
* ConfirmRegistOp：门诊挂号中，点击确定按钮产生该请求，真正的医保结算交易此时调用
* AbortRegistOp：门诊挂号中，HIS在调用挂号确认（ConfirmRegistOp）成功后，HIS保存数据失败，HIS需自动产生该请求，用来取消之前的挂号操作，主要用在先结医保后结HIS的业务场景下
* PrintRegistOp：门诊挂号中，票据打印时产生该请求，用于获取发票上显示的医保支付相关信息
* ReadCardCancelRegistOp：门诊退号中，点击读卡或者回车事件产生该请求
* CancelRegistOp：门诊退号中，点击确定时产生该请求，撤销医保的挂号交易

### 门诊收费
* ReadCardChargeOp：门诊收费中，在收费界面点击读卡时产生该请求，用于病人的身份认证
* CalcFeeChargeOp：门诊开单时，录入费用明细时产生该请求，用于获取药品/项目的自费和自负比例
* ReadyChargeOp：门诊收费中，点击收费结算键时产生该请求，用于进行费用明细的上传，调用医保结算计算方法获取医保支付信息操作
* CancelReadyChargeOp：门诊收费中，在关闭结算窗口取消正在进行的结算时需自动产生该请求，用于撤销预结算（ReadyChargeOp）操作中进行过的撤销费用上传等操作
* ConfirmChargeOp：门诊收费中，在收费界面点击确认时产生该请求
* AbortChargeOp：门诊收费中，在HIS调用收费确认（ConfirmChargeOp）成功后，HIS保存数据失败，HIS需自动产生该请求，用来取消之前的结算操作，主要用在先结医保后结HIS的业务场景下。
* PrintChargeOp：门诊收费中，票据打印时产生该请求，用于获取发票上显示的医保支付相关信息
* ReadCardCanelChargesOp：门诊退费中，点击读卡或回车事件产生该请求
* CancelChargeOp：门诊退费中，退款界面点击确认产生该请求

### 住院业务
* ReadCardRegistIp：住院登记时，读卡键产生该请求
* ReadyRegistOp：住院登记时，某些医保可能会要求填写一些入院信息，而这些信息是此类医保专属，这样则可以统一在此事件中进行输入
* ConfirmRegistIp：住院登记，点击确认键时产生该请求
* ReadCardCancelRegistOp：住院取消登记时，点击读卡或者回车事件产生该请求
* CancelRegistIp：住院取消登记时，点击确认按钮时产生该请求
* CalcFeeChargeIp：住院业务中，进行费用记账时产生该请求，用于获取药品/项目的自费和自负比例
* ReadyChargeIp：住院结算时，点击收费结算键时产生该请求，用于进行费用明细的上传，调用医保结算计算方法获取医保支付信息操作
* CancelReadyChargeIp：住院结算时，在关闭结算窗口取消正在进行的结算时需自动产生该请求，用于撤销预结算（ReadyChargeOp）操作中进行过的撤销费用上传等操作
* ConfirmChargeIp：住院结算中，在收费界面点击确认时产生该请求
* AbortChargeIp：住院结算中，在HIS调用收费确认（ConfirmChargeIp）成功后，HIS保存数据失败，HIS需自动产生该请求，用来取消之前的结算操作，主要用在先结医保后结HIS的业务场景下。
* PrintChargeOp：住院结算中，票据打印时产生该请求，用于获取发票上显示的医保支付相关信息

通过以上接口设计可以看出，在HIS中埋入指定的事件，在特定操作的时候触发，这样将不同医保的不同接口进行统一，隔离了HIS和医保接口之间的业务操作，降低了耦合度，提升了程序的可维护性。程序需要一个医保父类实现所有的接口，父类中所有方法均按照自费提供返回值，各个地区不同的医保都需要继承父类，根据医保政策软件实现不同的医保接口业务，HIS中触发的事件无论医保业务中需不需要处理，医保对象中都需要有指定的方法触发或者调用父类的方法，比如上海市门诊医保不需要上传费用明细，在CancelReadyChargeOp事件中则不需要和医保交互，直接返回正确即可，而河南省医保预结算前需要上传费用明细，CancelReadyChargeOp事件中则需要和医保交互撤销上传的费用明细。
随着不断的医保实践，现在设计接口有可能不符合某些地区医保接口，HIS中有可能会增加触发事件，这样我们需要在父类中增加相应的事件，然后在特定的医保子类对象中重写该事件即可，严谨将业务嵌入HIS业务中。

## 医保政策软件的调用
随着技术的发展，BS架构的HIS程序越来越多，HIS中对于医保政策软件的调用必不可少，医保政策软件大多是提供dll来让HIS厂商进行调用，我们采取最多的方法是将dll封装为ocx，在客户端注册然后浏览器中作为插件进行相应方法的调用，这种方式对于程序的正常使用是没有问题的，但是考虑到程序的稳定性，拓展性以及浏览器的支持，这里提出另一种调用方式：在客户端运行一个专门用于调用本地程序的软件，浏览器通过http的方式和该程序进行交互，该程序收到请求后调用医保政策软件，然后将结果返回给浏览器。
在浏览器和医保政策软件中增加这个中间程序，可以降低浏览器因插件崩溃的几率，而且浏览器不受插件的限制，可以升级到更高版本，享受浏览器性能上的优化。

[浏览器调用本地程序的一些想法](https://wrxiang.github.io/2019/01/26/%E6%B5%8F%E8%A7%88%E5%99%A8%E8%B0%83%E7%94%A8%E6%9C%AC%E5%9C%B0%E7%A8%8B%E5%BA%8F%E7%9A%84%E4%B8%80%E4%BA%9B%E6%83%B3%E6%B3%95/)
[浏览器调用本地程序程序实现](https://github.com/wrxiang/WebRunLocal/)




